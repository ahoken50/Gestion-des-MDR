rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isValidInventoryItem() {
      return request.resource.data.name is string
        && request.resource.data.quantity is number
        && request.resource.data.quantity >= 0
        && request.resource.data.location is string;
    }
    
    function isValidPickupRequest() {
      return request.resource.data.requestNumber is number
        && request.resource.data.contactName is string
        && request.resource.data.contactPhone is string
        && request.resource.data.status in ['pending', 'in_progress', 'completed', 'cancelled']
        && request.resource.data.items is list
        && request.resource.data.items.size() > 0;
    }

    // Règles pour les compteurs
    match /counters/{document} {
      allow read: if true;
      // CREATE: Initialiser à 1
      allow create: if request.resource.data.value == 1;
      // UPDATE: Incrémenter de 1 seulement, de manière atomique
      allow update: if request.resource.data.value == resource.data.value + 1;
    }

    // Règles pour les demandes de ramassage
    match /pickupRequests/{requestId} {
      allow read: if true;
      
      // Création: status doit être 'pending' ou 'completed' (pour import)
      allow create: if isValidPickupRequest()
        && request.resource.data.status in ['pending', 'completed'];

      // Mise à jour: préserver requestNumber
      allow update: if isValidPickupRequest()
        && request.resource.data.requestNumber == resource.data.requestNumber;
      
      // SECURITY: Empêcher la suppression
      allow delete: if false;
    }
    
    // Règles pour l'inventaire
    match /inventory/{itemId} {
      allow read: if true;
      // SECURITY: Valider la structure et empêcher les quantités négatives
      allow create, update: if isValidInventoryItem();
      // SECURITY: Empêcher la suppression (l'app utilise update pour synchroniser)
      allow delete: if false;
    }
  }
}

// Règles pour Firebase Storage - Accès public
service firebase.storage {
  match /b/{bucket}/o {
    // Images des demandes - Accès public
    match /requests/{requestId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.resource.size < 10 * 1024 * 1024;
    }
    // Factures - Accès public
    match /invoices/{requestId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.resource.size < 10 * 1024 * 1024;
    }
  }
}
